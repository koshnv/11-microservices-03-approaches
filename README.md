# Домашнее задание к занятию «Микросервисы: подходы»

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.


## Задача 1: Обеспечить разработку

Предложите решение для обеспечения процесса разработки: хранение исходного кода, непрерывная интеграция и непрерывная поставка. 
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- облачная система;
- система контроля версий Git;
- репозиторий на каждый сервис;
- запуск сборки по событию из системы контроля версий;
- запуск сборки по кнопке с указанием параметров;
- возможность привязать настройки к каждой сборке;
- возможность создания шаблонов для различных конфигураций сборок;
- возможность безопасного хранения секретных данных (пароли, ключи доступа);
- несколько конфигураций для сборки из одного репозитория;
- кастомные шаги при сборке;
- собственные докер-образы для сборки проектов;
- возможность развернуть агентов сборки на собственных серверах;
- возможность параллельного запуска нескольких сборок;
- возможность параллельного запуска тестов.

Обоснуйте свой выбор.
---

### Сравнение решений

| Система            | Git | CI/CD | Параметры сборки | Шаблоны | Секреты                     | Docker | Самостоятельные агенты | UI |
| ------------------ | --- | ----- | ---------------- | ------- | --------------------------- | ------ | ---------------------- | -- |
| **GitLab**         | +   | +     | +                | +       | Частично (env vars) + Vault | +      | +                      | +  |
| **Jenkins**        | +   | +     | +                | +       | + (через Vault и плагин)    | +      | +                      | +  |
| **TeamCity**       | +   | +     | +                | +       | +                           | +      | +                      | +  |
| **GitHub Actions** | +   | +     | +                | +       | Частично (Secrets)          | +      | -                      | +  |

---

### Выбор и обоснование

На текущий момент в нашей компании активно используется **GitLab**, и он отлично справляется со всеми задачами:

* GitLab объединяет в себе систему контроля версий, CI/CD пайплайны и управление репозиториями;
* Поддерживает pipeline-шаблоны, кастомные образы, секреты (в переменных), и интеграции с внешними хранилищами секретов (например, **HashiCorp Vault**);
* Есть возможность запускать свои GitLab Runner'ы на физических или виртуальных серверах;
* Удобный UI и логика pipeline на YAML делают систему понятной и гибкой.

Для безопасного хранения секретов рекомендуем использовать связку **GitLab + HashiCorp Vault**, т.к. переменные в GitLab не всегда подходят для хранения чувствительных данных.

---

## Задача 2: Логи

Предложите решение для обеспечения сбора и анализа логов сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- сбор логов в центральное хранилище со всех хостов, обслуживающих систему;
- минимальные требования к приложениям, сбор логов из stdout;
- гарантированная доставка логов до центрального хранилища;
- обеспечение поиска и фильтрации по записям логов;
- обеспечение пользовательского интерфейса с возможностью предоставления доступа разработчикам для поиска по записям логов;
- возможность дать ссылку на сохранённый поиск по записям логов.

Обоснуйте свой выбор.
---

### Решение: стек **ELK + Filebeat**

#### Компоненты:

* **Filebeat** — лёгкий агент для сбора логов из stdout, файлов и системных журналов, устанавливается на каждый хост;
* **Logstash** — собирает, фильтрует и обогащает данные, управляет маршрутами доставки логов;
* **Elasticsearch** — высокопроизводительное хранилище логов с полнотекстовым поиском;
* **Kibana** — веб-интерфейс для поиска, анализа и визуализации логов.

---

### Обоснование

* ELK-стек (Elastic + Beats) является **де-факто стандартом** в логировании микросервисных систем;
* Система гибко масштабируется, можно разделять доступ на уровне Kibana Spaces;
* Поддерживает сохранённые фильтры, временные рамки и шаринг ссылок на поисковые запросы;
* Есть возможность добавить буферизацию через Kafka или Redis между Logstash и Elasticsearch — для обеспечения доставки.

Альтернатива: **Loki + Grafana**, если приоритет — лёгкость развертывания и интеграция с Prometheus-экосистемой.

---

## Задача 3: Мониторинг

Предложите решение для обеспечения сбора и анализа состояния хостов и сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- сбор метрик со всех хостов, обслуживающих систему;
- сбор метрик состояния ресурсов хостов: CPU, RAM, HDD, Network;
- сбор метрик потребляемых ресурсов для каждого сервиса: CPU, RAM, HDD, Network;
- сбор метрик, специфичных для каждого сервиса;
- пользовательский интерфейс с возможностью делать запросы и агрегировать информацию;
- пользовательский интерфейс с возможностью настраивать различные панели для отслеживания состояния системы.

Обоснуйте свой выбор.

---

### Решение: **Prometheus + Grafana + Node Exporter + cAdvisor**

#### Компоненты:

* **Prometheus** — система мониторинга и хранения метрик с языком запросов PromQL;
* **Node Exporter** — собирает метрики с хостов (CPU, RAM, диск, сеть);
* **cAdvisor** — собирает метрики с контейнеров (CPU, память, IO);
* **Grafana** — визуализация, дашборды, алерты и фильтрация по меткам.

---

### Обоснование

* Стек является **стандартом в Kubernetes и микросервисах**;
* Прост в развёртывании и масштабировании;
* PromQL — мощный язык агрегации данных, позволяет формулировать гибкие запросы;
* Grafana позволяет создавать дашборды по ролям (DevOps, разработчик, бизнес);
* Широкое сообщество и большое количество готовых панелей и exporters.

Также можно добавить **Alertmanager** — для уведомлений по событиям (Slack, Telegram, почта и т.д.).
Можно еще предложить zabbix с Zabbix Agent 2 для микросервисов, в прошлой компании он был стандартом.
 Когда Zabbix — особенно удачный выбор:
    1. Уже развёрнут и администрируется в инфраструктуре;
    2. Нужно централизованное решение "всё в одном": мониторинг + алерты + визуализация;
    3. Нужна поддержка разнообразного оборудования (SNMP, IPMI, агенты, Windows/Linux);
    4. Интеграция с CMDB, SLA и отчетностью.
Когда лучше Prometheus + Grafana:
    1. Используется Kubernetes;
    2. Нужна высокая гибкость и глубина аналитики (PromQL);
    3. Микросервисы активно экспортируют метрики в формате Prometheus;
    4. Нужны лёгкие и распределённые компоненты.